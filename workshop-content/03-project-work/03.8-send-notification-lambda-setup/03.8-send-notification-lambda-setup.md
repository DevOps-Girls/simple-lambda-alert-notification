# Create a Lambda to Send Notifications

Let's set up the function in Serverless. Under functions, define a new `send-notifications` function like this:

```yaml
  functions: 
  get-generated-dog-name:
    handler: src/handlers/get-generated-dog-name/endpoint.handler
    role: GetGeneratedDogNameLambdaExecutionRole
    events: 
      - http: 
          path: generate/{breed}/name
          method: get
          cors: true
  send-notifications: 
    handler: src/handlers/send-notifications/send-notifications.handler
    role: SendNotificationsLambdaExecutionRole
    environment: 
      SNS_TOPIC_ARN: { Ref: <SNSTopic> }
    events: 
      - sqs:
          arn:
            Fn::GetAtt: [<QueueName>, Arn]
          batchSize: 1

package:
  exclude:
    - node_modules/aws-sdk/**

resources: 
  Resources:
    GetGeneratedDogNameLambdaExecutionRole:
      Type: AWS::IAM::Role
      Properties:
        AssumeRolePolicyDocument:
          Version: "2012-10-17"
          Statement:
            - Effect: "Allow"
              Principal:
                Service: 
                  - lambda.amazonaws.com
              Action: 
                - sts:AssumeRole
        Policies:
          - PolicyName: GetGeneratedDogNameLambdaExecutionPolicy
            PolicyDocument:
              Version: "2012-10-17"
              Statement:
                - Effect: "Allow"
                  Action:
                    - "logs:CreateLogGroup"
                    - "logs:CreateLogStream"
                    - "logs:PutLogEvents"
                  Resource: "*"

    SendNotificationsLambdaExecutionRole:
      Type: AWS::IAM::Role
      Properties:
        AssumeRolePolicyDocument:
          Version: "2012-10-17"
          Statement:
            - Effect: "Allow"
              Principal:
                Service: 
                  - lambda.amazonaws.com
              Action: 
                - sts:AssumeRole
        Policies:
          - PolicyName: SendNotificationsLambdaExecutionPolicy
            PolicyDocument:
              Version: "2012-10-17"
              Statement:
                - Effect: "Allow"
                  Action:
                    - "logs:CreateLogGroup"
                    - "logs:CreateLogStream"
                    - "logs:PutLogEvents"
                    - "sns:Publish"
                    - "sqs:ReceiveMessage"
                    - "sqs:DeleteMessage"
                    - "sqs:GetQueueAttributes"
                    - "sqs:GetQueueUrl"
                  Resource: 
                    - Fn::GetAtt: [<QueueName>, Arn]
                    - Fn::GetAtt: [<DLQName>, Arn]
                    - "arn:aws:sns:ap-southeast-2:*:*"
                    - "arn:aws:sns:*:*:+*" 
```
### Handler
This property references the Lambda function handler, which is the code that processes events.

### Environment
We can define the environment value SNS_TOPIC_ARN by referencing the SNS topic ARN created in the serverless.yml file.

### Events:
The function will be called every time a message is sent to the SQS queue. We reference this by the ARN (AWS Resource Name) using the Fn::GetAtt function.

## Send Notification Using AWS SNS
In src/handlers/send-notifications/send-notifications.js, we're going to use the AWS SDK v3 to send an SMS notification within the handler function.

```
const { SNSClient, PublishCommand } = require("@aws-sdk/client-sns");

const snsClient = new SNSClient({ region: "ap-southeast-2" });

module.exports.handler = async (event) => {
  console.log('Received event:', JSON.stringify(event, null, 2));

  if (!event.Records || !Array.isArray(event.Records) || event.Records.length === 0) {
    console.error('No records found in the event:', JSON.stringify(event, null, 2));
    return {
      statusCode: 400,
      body: JSON.stringify({ message: 'No records found in the event' }),
    };
  }

  const message = 'Oops! Something went wrong with the Dog Generator service.'; // Assuming the message body contains the notification content

  // Send SMS notification
  const smsParams = {
    Message: message,
    PhoneNumber: '+61468392099356784', // Replace with your phone number
    MessageAttributes: {
      'AWS.SNS.SMS.SenderID': {
        DataType: 'String',
        StringValue: 'MySenderID'
      },
      'AWS.SNS.SMS.SMSType': {
        DataType: 'String',
        StringValue: 'Transactional'
      }
    }
  };

  try {
    const command = new PublishCommand(smsParams);
    const result = await snsClient.send(command);
    console.log('SMS notification sent successfully', result);
  } catch (error) {
    console.error('Failed to send SMS notification', error);
  }

  return {
    statusCode: 200,
    body: JSON.stringify({ message: 'Notifications processed successfully' }),
  };
};
```

Please run `yarn add @aws-sdk/client-sns` because V2 SDK is not provided by default.


## Let's deploy and test
- Deploy the cloudformation stack again
- Trigger an error using the `cURL` command
- Check your phone for SMS

# [NEXT SECTION - Cleanup üëâüèΩ](../03.9-cleanup/03.9-cleanup.md)